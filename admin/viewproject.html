<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>View Projects - Admin Dashboard</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="img/favicon.ico" rel="icon">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <script>
    if (localStorage.getItem('admin_signed_in') !== 'true') {
        window.location.href = 'signin.html';
    }
    </script>

    <div class="container-fluid position-relative d-flex p-0">
        <div class="sidebar pe-4 pb-3">
            <nav class="navbar bg-secondary navbar-dark">
                <a href="index.html" class="navbar-brand mx-4 mb-3">
                    <h3 class="text-primary"><i class="fa fa-user-edit me-2"></i>DatabyGagan</h3>
                </a>
                <div class="d-flex align-items-center ms-4 mb-4">
                    <div class="position-relative">
                        <img class="rounded-circle" src="../assets/favicon-192x192.png" alt="Gagan Logo" style="width: 40px; height: 40px;">
                        <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"></div>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">Gagan</h6>
                        <span>Admin</span>
                    </div>
                </div>
                <div class="navbar-nav w-100">
                    <a href="admin/index.html" class="nav-item nav-link"><i class="fa fa-tachometer-alt me-2"></i>Dashboard</a>
                    <a href="addproject.html" class="nav-item nav-link"><i class="fa fa-plus me-2"></i>Add Project</a>
                    <a href="viewproject.html" class="nav-item nav-link active"><i class="fa fa-list me-2"></i>View Projects</a>
                </div>
            </nav>
        </div>
        <div class="content">
            <div class="container-fluid pt-4 px-4">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="bg-secondary rounded h-100 p-4">
                            <h3 class="mb-4 text-primary">All Projects</h3>
                            <table class="table table-dark table-striped">
                                <thead>
                                    <tr>
                                        <th scope="col">Image</th>
                                        <th scope="col">Title</th>
                                        <th scope="col">Category</th>
                                        <th scope="col">Description</th>
                                        <th scope="col">Dashboard URL</th>
                                        <th scope="col">Code URL</th>
                                        <th scope="col">Tech Tags</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="project-list">
                                    <!-- Projects will be loaded here dynamically -->
                                    <!-- Example row with Edit button -->
                                    <!--
                                    <tr>
                                        <td><img src="img/project1.jpg" alt="Project Image" style="width:60px;height:60px;border-radius:6px;"></td>
                                        <td>Project Title</td>
                                        <td>Category</td>
                                        <td>Project Description</td>
                                        <td><a href="#">Dashboard URL</a></td>
                                        <td><a href="#">Code URL</a></td>
                                        <td>Tech Tags</td>
                                        <td>
                                            <button type="button" class="btn btn-primary m-2" data-bs-toggle="modal" data-bs-target="#editProjectModal"><i class="fa fa-edit me-1"></i>Edit</button>
                                            <button type="button" class="btn btn-danger m-2"><i class="fa fa-trash me-1"></i>Delete</button>
                                        </td>
                                    </tr>
                                    -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <!-- Edit Project Modal -->
        <div class="modal fade" id="editProjectModal" tabindex="-1" aria-labelledby="editProjectModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editProjectModalLabel">Edit Project</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="edit-project-form">
                            <div class="mb-3">
                                <label for="edit-title" class="form-label">Project Title</label>
                                <input type="text" class="form-control" id="edit-title" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-category" class="form-label">Category</label>
                                <input type="text" class="form-control" id="edit-category" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-imageUpload" class="form-label">Image Upload</label>
                                <input class="form-control" type="file" id="edit-imageUpload" accept="image/*">
                            </div>
                            <div class="mb-3">
                                <label for="edit-alt" class="form-label">Image Alt Text</label>
                                <input type="text" class="form-control" id="edit-alt" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-dashboardUrl" class="form-label">Dashboard URL</label>
                                <input type="url" class="form-control" id="edit-dashboardUrl" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-codeUrl" class="form-label">Code URL</label>
                                <input type="url" class="form-control" id="edit-codeUrl" required>
                            </div>
                            <div class="mb-3">
                                <label for="edit-description" class="form-label">Project Description</label>
                                <textarea class="form-control" id="edit-description" style="height: 100px" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="edit-tech" class="form-label">Tech Tags (comma separated)</label>
                                <input type="text" class="form-control" id="edit-tech" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/main.js"></script>
    <script>
    // Helper: Convert tech array to comma string
    function techToString(tech) {
        if (Array.isArray(tech)) return tech.join(", ");
        if (typeof tech === "string") return tech;
        return "";
    }

    // Unified CRUD logic from admin.html
    let projects = [];
    function loadProjects() {
        fetch('/api/projects')
            .then(res => {
                if (!res.ok) throw new Error('Failed to fetch projects from server');
                return res.json();
            })
            .then(data => {
                projects = data;
                renderProjects();
            })
            .catch(err => {
                alert('Error loading projects: ' + err);
            });
    }
    function renderProjects() {
        const tbody = document.getElementById('project-list');
        tbody.innerHTML = '';
        projects.forEach((proj, idx) => {
            let imgHtml = '';
            if (proj.image) {
                let imgSrc = proj.image.startsWith('http') ? proj.image : proj.image;
                imgHtml = `<img src="${imgSrc}" alt="${proj.alt || ''}" style="width:60px;height:60px;border-radius:6px;">`;
            }
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${imgHtml}</td>
                <td>${proj.title}</td>
                <td>${proj.category}</td>
                <td>${proj.description}</td>
                <td><a href="${proj.dashboardUrl || '#'}" target="_blank">Dashboard</a></td>
                <td><a href="${proj.codeUrl || '#'}" target="_blank">Code</a></td>
                <td>${techToString(proj.tech)}</td>
                <td>
                    <button type="button" class="btn btn-primary m-2" data-bs-toggle="modal" data-bs-target="#editProjectModal" onclick="openEditModal(${idx})"><i class="fa fa-edit me-1"></i>Edit</button>
                    <button type="button" class="btn btn-danger m-2" onclick="deleteProjectByTitle('${encodeURIComponent(proj.title)}')"><i class="fa fa-trash me-1"></i>Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }
    // Initial load
    window.addEventListener('DOMContentLoaded', loadProjects);

    // Open edit modal and fill form
    function openEditModal(idx) {
        const project = window.projects[idx];
        if (!project) return;
        document.getElementById('edit-title').value = project.title;
        document.getElementById('edit-category').value = project.category;
        document.getElementById('edit-alt').value = project.alt;
        document.getElementById('edit-dashboardUrl').value = project.dashboardUrl;
        document.getElementById('edit-codeUrl').value = project.codeUrl;
        document.getElementById('edit-description').value = project.description;
        document.getElementById('edit-tech').value = techToString(project.tech);
        document.getElementById('edit-imageUpload').value = '';
        document.getElementById('edit-imageUpload').setAttribute('data-prev', project.image || '');
        window.currentEditIdx = idx;
    }

    // Edit project form submit
    document.getElementById('edit-project-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const idx = window.currentEditIdx;
        const project = window.projects[idx];
        const title = document.getElementById('edit-title').value;
        const category = document.getElementById('edit-category').value;
        const alt = document.getElementById('edit-alt').value;
        const dashboardUrl = document.getElementById('edit-dashboardUrl').value;
        const codeUrl = document.getElementById('edit-codeUrl').value;
        const description = document.getElementById('edit-description').value;
        const tech = document.getElementById('edit-tech').value.split(',').map(t => t.trim());
        const fileInput = document.getElementById('edit-imageUpload');
        let imagePath = project.image || '';
        async function updateProjectWithImage(imgPath) {
            const payload = { title, category, alt, dashboardUrl, codeUrl, description, tech, image: imgPath };
            try {
                const res = await fetch(`/api/projects/title/${encodeURIComponent(project.title)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    loadProjects();
                } else {
                    alert('Error updating project: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Error updating project: ' + err);
            }
        }
        if (fileInput.files.length > 0) {
            // Upload new image
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            try {
                const res = await fetch('/.netlify/functions/upload-image', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (data.success && data.imagePath) {
                    updateProjectWithImage(data.imagePath);
                } else {
                    alert('Image upload failed: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Image upload error: ' + err);
            }
        } else {
            // No new image
            updateProjectWithImage(imagePath);
        }
        // Close modal
        var modal = bootstrap.Modal.getInstance(document.getElementById('editProjectModal'));
        modal.hide();
    });

    // Delete project by title
    async function deleteProjectByTitle(title) {
        if (!confirm('Are you sure you want to delete this project?')) return;
        try {
            const res = await fetch(`/api/projects/title/${title}`, {
                method: 'DELETE'
            });
            const data = await res.json();
            if (data.success) {
                loadProjects();
            } else {
                alert('Error deleting project: ' + (data.error || 'Unknown error'));
            }
        } catch (err) {
            alert('Error deleting project: ' + err);
        }
    }

    // Initial load
    window.addEventListener('DOMContentLoaded', loadProjects);
    </script>
</body>
</html>