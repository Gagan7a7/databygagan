<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Add Project - Admin Dashboard</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="img/favicon.ico" rel="icon">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container-fluid position-relative d-flex p-0">
        <div class="sidebar pe-4 pb-3">
            <nav class="navbar bg-secondary navbar-dark">
                <a href="dashboard.html" class="navbar-brand mx-4 mb-3">
                    <h3 class="text-primary"><i class="fa fa-user-edit me-2"></i>DatabyGagan</h3>
                </a>
                <div class="d-flex align-items-center ms-4 mb-4">
                    <div class="position-relative">
                        <img class="rounded-circle" src="../assets/favicon-192x192.png" alt="Gagan Logo" style="width: 40px; height: 40px;">
                        <div class="bg-success rounded-circle border border-2 border-white position-absolute end-0 bottom-0 p-1"></div>
                    </div>
                    <div class="ms-3">
                        <h6 class="mb-0">Gagan</h6>
                        <span>Admin</span>
                    </div>
                </div>
                <div class="navbar-nav w-100">
                    <a href="dashboard.html" class="nav-item nav-link"><i class="fa fa-tachometer-alt me-2"></i>Dashboard</a>
                    <a href="addproject.html" class="nav-item nav-link active"><i class="fa fa-plus me-2"></i>Add Project</a>
                    <a href="viewproject.html" class="nav-item nav-link"><i class="fa fa-list me-2"></i>View Projects</a>
                </div>
            </nav>
        </div>
        <div class="content">
            <div class="container-fluid pt-4 px-4">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="bg-secondary rounded h-100 p-4">
                            <h3 class="mb-4 text-primary">Add New Project</h3>
                            <form id="add-project-form">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="title" placeholder="Project Title" required>
                                    <label for="title">Project Title</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="category" placeholder="Category" required>
                                    <label for="category">Category</label>
                                </div>
                                <div class="mb-3">
                                    <label for="imageUpload" class="form-label">Image Upload</label>
                                    <input class="form-control" type="file" id="imageUpload" accept="image/*">
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="alt" placeholder="Image Alt Text" required>
                                    <label for="alt">Image Alt Text</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="url" class="form-control" id="dashboardUrl" placeholder="Dashboard URL" required>
                                    <label for="dashboardUrl">Dashboard URL</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="url" class="form-control" id="codeUrl" placeholder="Code URL" required>
                                    <label for="codeUrl">Code URL</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <textarea class="form-control" id="description" placeholder="Project Description" style="height: 100px" required></textarea>
                                    <label for="description">Project Description</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="tech" placeholder="Tech Tags (comma separated)" required>
                                    <label for="tech">Tech Tags (comma separated)</label>
                                </div>
                                <button type="submit" class="btn btn-primary">Save Project</button>
                                <button type="reset" class="btn btn-secondary ms-2">Reset</button>
                            </form>
                            <div id="notification" class="text-success mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Removed Bootstrap JS and jQuery references for pure vanilla JS logic -->
    <script>
    if (localStorage.getItem('admin_signed_in') !== 'true') {
        window.location.href = 'signin.html';
    }
    </script>
    <!-- Add JS logic for form submission here if needed -->
    <script>
    // Exact admin.html logic for add/edit/delete
    let projects = [];
    function loadProjects() {
        fetch('/api/projects')
            .then(res => {
                if (!res.ok) throw new Error('Failed to fetch projects from server');
                return res.json();
            })
            .then(data => {
                projects = data;
                renderProjects();
            })
            .catch(err => {
                document.getElementById('notification').textContent = 'Error loading projects: ' + err;
            });
    }
    function renderProjects() {
        const list = document.getElementById('project-list');
        if (!list) return;
        list.innerHTML = '';
        projects.forEach((proj, idx) => {
            const div = document.createElement('div');
            div.className = 'project-item';
            let imgHtml = '';
            if (proj.image) {
                let imgSrc = proj.image.startsWith('http') ? proj.image : proj.image;
                imgHtml = `<img src="${imgSrc}" alt="${proj.alt || ''}" style="max-width:60px;max-height:60px;margin-right:12px;border-radius:6px;vertical-align:middle;">`;
            }
            div.innerHTML = `${imgHtml}<b>${proj.title}</b> <button onclick="editProject(${idx})">Edit</button> <button onclick="deleteProjectByTitle('${encodeURIComponent(proj.title)}')">Delete</button>`;
            list.appendChild(div);
        });
    }
    document.getElementById('add-project-form').onsubmit = function(e) {
        e.preventDefault();
        const idx = document.getElementById('edit-index') ? document.getElementById('edit-index').value : '';
        const imageFile = document.getElementById('imageUpload').files[0];
        const proj = {
            title: document.getElementById('title').value,
            category: document.getElementById('category').value,
            image: '',
            alt: document.getElementById('alt').value,
            dashboardUrl: document.getElementById('dashboardUrl').value,
            codeUrl: document.getElementById('codeUrl').value,
            description: document.getElementById('description').value,
            tech: document.getElementById('tech').value.split(',').map(t => t.trim())
        };
        function saveProjectWithImage(imagePath) {
            proj.image = imagePath;
            if (idx === '') {
                fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(proj)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        projects.push(proj);
                        renderProjects();
                        resetForm();
                        document.getElementById('notification').textContent = 'Project added and saved to server!';
                    } else {
                        document.getElementById('notification').textContent = 'Error saving project: ' + (data.error || 'Unknown error');
                    }
                })
                .catch(err => {
                    document.getElementById('notification').textContent = 'Error saving project: ' + err;
                });
            } else {
                const editTitle = encodeURIComponent(projects[idx].title);
                fetch(`/api/projects/title/${editTitle}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(proj)
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        projects[idx] = proj;
                        renderProjects();
                        resetForm();
                        document.getElementById('notification').textContent = 'Project updated on server!';
                    } else {
                        document.getElementById('notification').textContent = 'Error updating project: ' + (data.error || 'Unknown error');
                    }
                })
                .catch(err => {
                    document.getElementById('notification').textContent = 'Error updating project: ' + err;
                });
            }
        }
        if (imageFile) {
            const formData = new FormData();
            formData.append('image', imageFile);
            fetch('/.netlify/functions/upload-image', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.imagePath) {
                    saveProjectWithImage(data.imagePath);
                } else {
                    document.getElementById('notification').textContent = 'Image upload failed: ' + (data.error || 'Unknown error');
                }
            })
            .catch(err => {
                document.getElementById('notification').textContent = 'Image upload error: ' + err;
            });
        } else {
            let imagePath = '';
            if (idx !== '') {
                imagePath = projects[idx].image;
            }
            saveProjectWithImage(imagePath);
        }
    };
    function editProject(idx) {
        const proj = projects[idx];
        document.getElementById('edit-index').value = idx;
        document.getElementById('title').value = proj.title;
        document.getElementById('category').value = proj.category || '';
        document.getElementById('alt').value = proj.alt;
        document.getElementById('dashboardUrl').value = proj.dashboardUrl;
        document.getElementById('codeUrl').value = proj.codeUrl;
        document.getElementById('description').value = proj.description;
        document.getElementById('tech').value = proj.tech.join(', ');
        if (proj.image) {
            document.getElementById('imageUpload').value = '';
            document.getElementById('imageUpload').setAttribute('data-prev', proj.image);
        }
    }
    function deleteProjectByTitle(title) {
        if (confirm('Delete this project?')) {
            fetch(`/api/projects/title/${title}`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    projects = projects.filter(p => encodeURIComponent(p.title) !== title);
                    renderProjects();
                    document.getElementById('notification').textContent = 'Project deleted from server!';
                } else {
                    document.getElementById('notification').textContent = 'Error deleting project: ' + (data.error || 'Unknown error');
                }
            })
            .catch(err => {
                document.getElementById('notification').textContent = 'Error deleting project: ' + err;
            });
        }
    }
    function resetForm() {
        document.getElementById('edit-index').value = '';
        document.getElementById('add-project-form').reset();
    }
    window.addEventListener('DOMContentLoaded', loadProjects);
    </script>
</body>
</html>
