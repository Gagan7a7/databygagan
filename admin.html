<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="dns-prefetch" href="//databygagan.com">
    <!-- Custom domain is live -->
    <!-- Canonical URL for SEO -->
    <link rel="canonical" href="https://databygagan.com/admin.html">
    <!-- Netlify URL commented out -->
    <!-- <link rel="canonical" href="https://databygagan.netlify.app/admin.html"> -->
        <meta property="og:type" content="website">
    <meta property="og:url" content="https://databygagan.com/admin.html">
    <!-- Netlify URL commented out -->
    <!-- <meta property="og:url" content="https://databygagan.netlify.app/admin.html"> -->
        <meta property="og:title" content="Admin - Project Manager | Gagan BP">
        <meta property="og:description" content="Admin dashboard for managing portfolio projects on databygagan.com.">
        <script type="application/ld+json">
        {
            "@context": "https://schema.org",
            "@type": "WebPage",
            "url": "https://databygagan.com/admin.html",
            "name": "Admin - Project Manager | Gagan BP",
            "description": "Admin dashboard for managing portfolio projects on databygagan.com."
        }
        </script>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin - Project Manager</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <style>
        body {
            background: var(--gradient-bg);
            color: var(--light-text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
        }
        .admin-container {
            max-width: 520px;
            margin: 60px auto;
            padding: 36px 32px 32px 32px;
            background: rgb(25 25 40 / 0.85);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        h2 {
            text-align: center;
            margin-bottom: 2rem;
            background: var(--gradient-primary);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: #fff0;
        }
        .admin-form label {
            display: block;
            margin-top: 18px;
            color: var(--light-text);
            font-weight: 500;
        }
        .admin-form input, .admin-form textarea {
            width: 100%;
            padding: 12px 14px;
            margin-top: 6px;
            background: rgb(35 40 55 / 0.9);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--light-text);
            font-size: 1rem;
            transition: var(--transition);
        }
        .admin-form input:focus, .admin-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgb(74 144 226 / 0.15);
        }
        .admin-form button {
            margin-top: 20px;
            padding: 12px 24px;
            border-radius: 50px;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            background: var(--gradient-primary);
            color: #fff;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }
        .admin-form button[type="button"] {
            background: var(--secondary-color);
            color: #fff;
            margin-left: 10px;
        }
        .admin-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgb(74 144 226 / 0.18);
        }
        .project-list {
            margin-top: 36px;
            background: rgb(35 40 55 / 0.7);
            border-radius: 10px;
            padding: 18px 12px;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
        }
        .project-item {
            border-bottom: 1px solid var(--border-color);
            padding: 12px 0 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .project-item:last-child {
            border-bottom: none;
        }
        .project-item b {
            color: var(--secondary-color);
            font-size: 1.08rem;
        }
        .project-item button {
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 6px 14px;
            margin-left: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }
        .project-item button:hover {
            background: var(--primary-color);
        }
        .hidden {
            display: none;
        }
        .error {
            color: var(--accent-color);
            margin-top: 10px;
            font-size: 0.98rem;
        }
        #login-section input[type="password"] {
            margin-top: 10px;
            margin-bottom: 10px;
        }
        @media (max-width: 600px) {
            .admin-container {
                padding: 18px 6px 18px 6px;
            }
            .project-list {
                padding: 10px 2px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <aside class="sidebar">
            <div class="sidebar-title">Admin Dashboard</div>
            <nav>
                <ul>
                    <li><a href="#projects">Projects</a></li>
                    <li><a href="#analytics">Analytics</a></li>
                    <li><a href="#help">Help</a></li>
                </ul>
            </nav>
        </aside>
        <main class="main-content">
            <header class="topbar">
                <h2>Project Manager</h2>
                <div id="project-stats" style="font-size:1rem;color:#fff;"></div>
            </header>
            <!-- Added missing projects section for anchor link -->
            <section id="projects" class="hidden"></section>
            <section id="login-section">
                <label for="admin-password">Enter Admin Password:</label>
                <input type="password" id="admin-password">
                <button type="button" onclick="login()">Login</button>
                <div id="login-error" class="error"></div>
            </section>
            <section id="admin-section" class="hidden">
                <form class="admin-form" id="project-form">
                    <input type="hidden" id="edit-index">
                    <label>Title: <input type="text" id="title" required title="Project title"></label>
                    <label>Category: <input type="text" id="category" required placeholder="e.g. PowerBI, Colab, Other" title="Project category"></label>
                    <label>Image Upload: <input type="file" id="imageUpload" accept="image/*" title="Upload project image"></label>
                    <label>Alt Text: <input type="text" id="alt" required title="Image alt text for accessibility"></label>
                    <label>Dashboard URL: <input type="url" id="dashboardUrl" required title="Link to dashboard"></label>
                    <label>Code URL: <input type="url" id="codeUrl" required title="Link to code repository"></label>
                    <label>Description: <textarea id="description" required title="Project description"></textarea></label>
                    <label>Tech Tags (comma separated): <input type="text" id="tech" required title="Comma separated tech tags"></label>
                    <button type="submit">Save Project</button>
                    <button type="button" onclick="resetForm()">Reset</button>
                </form>
                <div class="project-list" id="project-list"></div>
                <div id="notification" class="hidden"></div>
            </section>
            <section id="analytics" class="hidden">
                <h3>Analytics</h3>
                <div id="analytics-content"></div>
            </section>
            <section id="help" class="hidden">
                <h3>Help &amp; Tips</h3>
                <ul>
                    <li>Fill all required fields before saving a project.</li>
                    <li>Use clear, descriptive titles and categories.</li>
                    <li>Upload optimized images for faster loading.</li>
                    <li>Tech tags help with search and filtering.</li>
                </ul>
            </section>
        </main>
    </div>
    <style>
        .dashboard-wrapper { display: flex; min-height: 100vh; }
        .sidebar { background: #23283b; color: #fff; width: 180px; padding: 24px 0; min-height: 100vh; }
        .sidebar-title { font-size: 1.3rem; font-weight: bold; margin-bottom: 24px; text-align: center; }
        .sidebar nav ul { list-style: none; padding: 0; }
        .sidebar nav ul li { margin: 18px 0; }
        .sidebar nav ul li a { color: #fff; text-decoration: none; font-size: 1.08rem; }
        .sidebar nav ul li a:hover { text-decoration: underline; }
        .main-content { flex: 1; padding: 32px 24px; background: var(--gradient-bg); }
        .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        #notification { margin-top: 18px; padding: 12px; border-radius: 6px; background: #23283b; color: #fff; font-weight: 500; }
        @media (max-width: 800px) {
            .dashboard-wrapper { flex-direction: column; }
            .sidebar { width: 100%; min-height: unset; padding: 12px 0; }
            .main-content { padding: 12px 6px; }
        }
    </style>
    <script>
        // Notification helper
        function showNotification(msg, type = 'info') {
            const notif = document.getElementById('notification');
            notif.textContent = msg;
            notif.className = '';
            notif.classList.add(type === 'error' ? 'error' : '');
            notif.classList.remove('hidden');
            setTimeout(() => notif.classList.add('hidden'), 3000);
        }
        // Secure backend password validation
        async function login() {
            const input = document.getElementById('admin-password').value;
            document.getElementById('login-error').textContent = '';
            try {
                const res = await fetch('/.netlify/functions/validate-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: input })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('admin-section').classList.remove('hidden');
                    loadProjects();
                } else {
                    document.getElementById('login-error').textContent = data.error || 'Incorrect password.';
                }
            } catch (err) {
                document.getElementById('login-error').textContent = 'Login error: ' + err;
            }
        }
        // Load projects from JSON
let projects = [];
function loadProjects() {
    // Fetch projects from backend API instead of static file
    fetch('/api/projects')
        .then(res => {
            if (!res.ok) throw new Error('Failed to fetch projects from server');
            return res.json();
        })
        .then(data => {
            projects = data;
            renderProjects();
        })
        .catch(err => {
            alert('Error loading projects: ' + err);
        });
}
        function renderProjects() {
            // Show project stats
            document.getElementById('project-stats').textContent = `Total Projects: ${projects.length}`;
            const list = document.getElementById('project-list');
            list.innerHTML = '';
            projects.forEach((proj, idx) => {
                const div = document.createElement('div');
                div.className = 'project-item';
                let imgHtml = '';
                if (proj.image) {
                    // If image path is a Cloudinary URL, use it directly; otherwise, prefix with assets/
                    let imgSrc = proj.image.startsWith('http') ? proj.image : proj.image;
                    imgHtml = `<img src="${imgSrc}" alt="${proj.alt || ''}" style="max-width:60px;max-height:60px;margin-right:12px;border-radius:6px;vertical-align:middle;">`;
                }
                div.innerHTML = `${imgHtml}<b>${proj.title}</b> <button onclick="editProject(${idx})">Edit</button> <button onclick="deleteProjectByTitle('${encodeURIComponent(proj.title)}')">Delete</button>`;
                list.appendChild(div);
            });
        }
        document.getElementById('project-form').onsubmit = function(e) {
            e.preventDefault();
            const idx = document.getElementById('edit-index').value;
            const imageFile = document.getElementById('imageUpload').files[0];
            const proj = {
                title: document.getElementById('title').value,
                category: document.getElementById('category').value,
                image: '', // will be set after upload
                alt: document.getElementById('alt').value,
                dashboardUrl: document.getElementById('dashboardUrl').value,
                codeUrl: document.getElementById('codeUrl').value,
                description: document.getElementById('description').value,
                tech: document.getElementById('tech').value.split(',').map(t => t.trim())
            };
            showNotification('Saving project...', 'info');
            const backendUrl = '/api/projects';
            function saveProjectWithImage(imagePath) {
                proj.image = imagePath;
                if (idx === '') {
                    fetch(backendUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proj)
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            projects.push(proj);
                            renderProjects();
                            resetForm();
                            showNotification('Project added and saved to server!', 'info');
                        } else {
                            alert('Error saving project: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(err => {
                        showNotification('Error saving project: ' + err, 'error');
                    });
                } else {
                    const editTitle = encodeURIComponent(projects[idx].title);
                    fetch(`${backendUrl}/title/${editTitle}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(proj)
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            projects[idx] = proj;
                            renderProjects();
                            resetForm();
                            showNotification('Project updated on server!', 'info');
                        } else {
                            alert('Error updating project: ' + (data.error || 'Unknown error'));
                        }
                    })
                    .catch(err => {
                        showNotification('Error updating project: ' + err, 'error');
                    });
                }
            }
            if (imageFile) {
                // Upload image first
                const formData = new FormData();
                formData.append('image', imageFile);
                fetch('/.netlify/functions/upload-image', {
                    method: 'POST',
                    body: formData
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.imagePath) {
                        saveProjectWithImage(data.imagePath);
                    } else {
                        alert('Image upload failed: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(err => {
                    alert('Image upload error: ' + err);
                });
            } else {
                // No new image uploaded, use previous value if editing
                let imagePath = '';
                if (idx !== '') {
                    imagePath = projects[idx].image;
                }
                saveProjectWithImage(imagePath);
            }
        };
        function editProject(idx) {
            const proj = projects[idx];
            document.getElementById('edit-index').value = idx;
            document.getElementById('title').value = proj.title;
            document.getElementById('category').value = proj.category || '';
            document.getElementById('alt').value = proj.alt;
            document.getElementById('dashboardUrl').value = proj.dashboardUrl;
            document.getElementById('codeUrl').value = proj.codeUrl;
            document.getElementById('description').value = proj.description;
            document.getElementById('tech').value = proj.tech.join(', ');
            // Show previous image path (optional)
            if (proj.image) {
                document.getElementById('imageUpload').value = '';
                document.getElementById('imageUpload').setAttribute('data-prev', proj.image);
            }
        }
function deleteProjectByTitle(title) {
    if (confirm('Delete this project?')) {
        // Send DELETE request to backend by title
        const backendUrl = '/api/projects/title/' + title;
        fetch(backendUrl, {
            method: 'DELETE'
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Remove from local array
                projects = projects.filter(p => encodeURIComponent(p.title) !== title);
                renderProjects();
                showNotification('Project deleted from server!', 'info');
            } else {
                alert('Error deleting project: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(err => {
            showNotification('Error deleting project: ' + err, 'error');
        });
    }
}
        function resetForm() {
            document.getElementById('edit-index').value = '';
            document.getElementById('project-form').reset();
        }
    </script>
</body>
</html>
